<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GhostShell License Manager</title>
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.21.4/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        // API Base URL
        const API_URL = 'https://black-pessah.onrender.com';

        // Navigation Component
        const Navbar = () => (
            <nav class="bg-blue-600 p-4 shadow-md">
                <div class="container mx-auto flex justify-between items-center">
                    <h1 class="text-white text-xl font-bold">GhostShell License Manager</h1>
                    <div class="space-x-4">
                        <a href="#/" class="text-white hover:text-blue-200">Validate License</a>
                        <a href="#/create" class="text-white hover:text-blue-200">Create License</a>
                        <a href="#/stats" class="text-white hover:text-blue-200">Statistics</a>
                    </div>
                </div>
            </nav>
        );

        // Validate License Component
        const ValidateLicense = () => {
            const [formData, setFormData] = useState({
                licenseKey: '',
                fingerprint: {
                    machine_id: '',
                    platform: '',
                    arch: ''
                },
                timestamp: new Date().toISOString(),
                version: '1.0.0'
            });
            const [response, setResponse] = useState(null);
            const [error, setError] = useState(null);
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError(null);
                setResponse(null);

                try {
                    const res = await fetch(`${API_URL}/validate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            license_key: formData.licenseKey,
                            fingerprint: formData.fingerprint,
                            timestamp: formData.timestamp,
                            version: formData.version
                        })
                    });
                    const data = await res.json();
                    setResponse(data);
                } catch (err) {
                    setError('Failed to validate license. Please try again.');
                } finally {
                    setLoading(false);
                }
            };

            const handleChange = (e) => {
                const { name, value } = e.target;
                if (name.startsWith('fingerprint.')) {
                    const key = name.split('.')[1];
                    setFormData({
                        ...formData,
                        fingerprint: { ...formData.fingerprint, [key]: value }
                    });
                } else {
                    setFormData({ ...formData, [name]: value });
                }
            };

            return (
                <div class="container mx-auto p-6">
                    <h2 class="text-2xl font-bold mb-4">Validate License</h2>
                    <form onSubmit={handleSubmit} class="bg-white p-6 rounded-lg shadow-md">
                        <div class="mb-4">
                            <label class="block text-gray-700">License Key</label>
                            <input
                                type="text"
                                name="licenseKey"
                                value={formData.licenseKey}
                                onChange={handleChange}
                                class="w-full p-2 border rounded"
                                placeholder="Enter license key"
                                required
                            />
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700">Machine ID</label>
                            <input
                                type="text"
                                name="fingerprint.machine_id"
                                value={formData.fingerprint.machine_id}
                                onChange={handleChange}
                                class="w-full p-2 border rounded"
                                placeholder="Enter machine ID"
                            />
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700">Platform</label>
                            <input
                                type="text"
                                name="fingerprint.platform"
                                value={formData.fingerprint.platform}
                                onChange={handleChange}
                                class="w-full p-2 border rounded"
                                placeholder="Enter platform"
                            />
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700">Architecture</label>
                            <input
                                type="text"
                                name="fingerprint.arch"
                                value={formData.fingerprint.arch}
                                onChange={handleChange}
                                class="w-full p-2 border rounded"
                                placeholder="Enter architecture"
                            />
                        </div>
                        <button
                            type="submit"
                            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
                            disabled={loading}
                        >
                            {loading ? 'Validating...' : 'Validate License'}
                        </button>
                    </form>
                    {response && (
                        <div class={`mt-4 p-4 rounded ${response.valid ? 'bg-green-100' : 'bg-red-100'}`}>
                            <p><strong>Status:</strong> {response.valid ? 'Valid' : 'Invalid'}</p>
                            <p><strong>Message:</strong> {response.message}</p>
                            {response.expires_at && (
                                <p><strong>Expires:</strong> {new Date(response.expires_at).toLocaleString()}</p>
                            )}
                            {response.remaining_validations !== null && (
                                <p><strong>Remaining Validations:</strong> {response.remaining_validations}</p>
                            )}
                        </div>
                    )}
                    {error && <div class="mt-4 p-4 bg-red-100 rounded">{error}</div>}
                </div>
            );
        };

        // Create License Component
        const CreateLicense = () => {
            const [formData, setFormData] = useState({
                licenseKey: '',
                expiresInDays: 365,
                maxInstances: 1
            });
            const [adminToken, setAdminToken] = useState('');
            const [response, setResponse] = useState(null);
            const [error, setError] = useState(null);
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError(null);
                setResponse(null);

                try {
                    const res = await fetch(`${API_URL}/create`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${adminToken}`
                        },
                        body: JSON.stringify(formData)
                    });
                    const data = await res.json();
                    if (res.status !== 200) {
                        throw new Error(data.detail || 'Failed to create license');
                    }
                    setResponse(data);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData({ ...formData, [name]: value });
            };

            return (
                <div class="container mx-auto p-6">
                    <h2 class="text-2xl font-bold mb-4">Create License (Admin)</h2>
                    <form onSubmit={handleSubmit} class="bg-white p-6 rounded-lg shadow-md">
                        <div class="mb-4">
                            <label class="block text-gray-700">Admin Token</label>
                            <input
                                type="text"
                                name="adminToken"
                                value={adminToken}
                                onChange={(e) => setAdminToken(e.target.value)}
                                class="w-full p-2 border rounded"
                                placeholder="Enter admin token"
                                required
                            />
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700">License Key (optional)</label>
                            <input
                                type="text"
                                name="licenseKey"
                                value={formData.licenseKey}
                                onChange={handleChange}
                                class="w-full p-2 border rounded"
                                placeholder="Leave blank to auto-generate"
                            />
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700">Expires In Days</label>
                            <input
                                type="number"
                                name="expiresInDays"
                                value={formData.expiresInDays}
                                onChange={handleChange}
                                class="w-full p-2 border rounded"
                                min="1"
                                required
                            />
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700">Max Instances</label>
                            <input
                                type="number"
                                name="maxInstances"
                                value={formData.maxInstances}
                                onChange={handleChange}
                                class="w-full p-2 border rounded"
                                min="1"
                                required
                            />
                        </div>
                        <button
                            type="submit"
                            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
                            disabled={loading}
                        >
                            {loading ? 'Creating...' : 'Create License'}
                        </button>
                    </form>
                    {response && (
                        <div class="mt-4 p-4 bg-green-100 rounded">
                            <p><strong>License Key:</strong> {response.license_key}</p>
                            <p><strong>Expires:</strong> {new Date(response.expires_at).toLocaleString()}</p>
                            <p><strong>Max Instances:</strong> {response.max_instances}</p>
                            <p><strong>Message:</strong> {response.message}</p>
                        </div>
                    )}
                    {error && <div class="mt-4 p-4 bg-red-100 rounded">{error}</div>}
                </div>
            );
        };

        // Stats Component
        const Stats = () => {
            const [adminToken, setAdminToken] = useState('');
            const [stats, setStats] = useState(null);
            const [error, setError] = useState(null);
            const [loading, setLoading] = useState(false);

            const fetchStats = async () => {
                setLoading(true);
                setError(null);
                setStats(null);

                try {
                    const res = await fetch(`${API_URL}/stats`, {
                        headers: {
                            'Authorization': `Bearer ${adminToken}`
                        }
                    });
                    const data = await res.json();
                    if (res.status !== 200) {
                        throw new Error(data.detail || 'Failed to fetch stats');
                    }
                    setStats(data);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div class="container mx-auto p-6">
                    <h2 class="text-2xl font-bold mb-4">License Statistics (Admin)</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="mb-4">
                            <label class="block text-gray-700">Admin Token</label>
                            <input
                                type="text"
                                value={adminToken}
                                onChange={(e) => setAdminToken(e.target.value)}
                                class="w-full p-2 border rounded"
                                placeholder="Enter admin token"
                            />
                        </div>
                        <button
                            onClick={fetchStats}
                            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
                            disabled={loading}
                        >
                            {loading ? 'Loading...' : 'Fetch Statistics'}
                        </button>
                    </div>
                    {stats && (
                        <div class="mt-4 p-4 bg-green-100 rounded">
                            <p><strong>Total Licenses:</strong> {stats.total_licenses}</p>
                            <p><strong>Active Licenses:</strong> {stats.active_licenses}</p>
                            <p><strong>Expired Licenses:</strong> {stats.expired_licenses}</p>
                            <p><strong>Recent Validations (7 days):</strong> {stats.recent_validations}</p>
                            <p><strong>Universal License Active:</strong> {stats.universal_license_active ? 'Yes' : 'No'}</p>
                        </div>
                    )}
                    {error && <div class="mt-4 p-4 bg-red-100 rounded">{error}</div>}
                </div>
            );
        };

        // Router Component
        const App = () => {
            const [page, setPage] = useState(window.location.hash.slice(1) || '/');

            useEffect(() => {
                const handleHashChange = () => {
                    setPage(window.location.hash.slice(1) || '/');
                };
                window.addEventListener('hashchange', handleHashChange);
                return () => window.removeEventListener('hashchange', handleHashChange);
            }, []);

            return (
                <div>
                    <Navbar />
                    {page === '/' && <ValidateLicense />}
                    {page === '/create' && <CreateLicense />}
                    {page === '/stats' && <Stats />}
                </div>
            );
        };

        // Render the App
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
